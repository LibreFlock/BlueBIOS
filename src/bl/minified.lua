::a::local blue=blue;local b,c;local component=component or require("component")local computer=computer or require("computer")local d=component.proxy(component.list("gpu")())local e,f=d.getResolution()function blue.fn.shell()local function g(h)d.fill(1,1,e,f," ")return d.set(math.ceil(e/2-#h/2),math.ceil(f/2),h)end;_G.buffer={}function _G.print(i)for j in string.gmatch(tostring(i),"[^\r\n]+")do if#tostring(i)>e then for k=1,math.ceil(#tostring(i)/e)do buffer[#buffer+1]=string.sub(tostring(i),k==1 and 1 or e*(k-1),e*k-1)end else buffer[#buffer+1]=tostring(i)end end end;function _G.help()print("exit Exits the shell")print("help() Access list of predefined functions")print("clear() Clears the current screen buffer")print("print(text: str) Print a string")print("To modify the buffer, the buffer dictionary exists.")print("Typically to add a new value in the shell's buffer, you need to modify buffer[#buffer+1].")print("The print function supports wrap around text.")print("Blue's predefined dictionary")print("'blue' is the global dictionary for blue's functions and variables.")print("Variables: 'blue.vb.init', 'blue.vb.boot_label', 'blue.vb.boot_drive'")print("Functions: 'blue.fn.shell'")end;function _G.clear()_G.buffer=nil end;buffer[1]="You are currently in a recovery shell in BIOS."buffer[2]="Enter 'help()' for a list of functions."..f;buffer[#buffer+1]="bootloader> "local l=false;local m=false;local n=""local o=true;local p=false;g("")::q::if type(buffer)~="table"then _G.buffer={}buffer[1]="bootloader> "end;if d.getDepth()<1 then p=true end;for k=1,f do if buffer[#buffer-k+1]then if k==1 and d.getDepth()>1 then if o then g("")end;local r=buffer[#buffer-k+1]if not p then d.fill(#r+1,f,f-#r-1,1," ")d.setForeground(0xaec5d4)d.set(1,f,r)d.setForeground(0x9cc3db)d.setBackground(0xaec5d4)d.set(#r+1,f," ")d.setBackground(0x003150)else d.setBackground(0x000000)d.setForeground(0xFFFFFF)d.fill(#r+1,f,f-#r-1,1," ")d.set(#r+1,f," ")d.setBackground(0xFFFFFF)d.set(1,f,r)d.setBackground(0x000000)end elseif o then d.set(1,f-k+1,buffer[#buffer-k+1])end end end;if o then o=false end;local s,j,t,u=computer.pullSignal()if not t then if s=="key_down"then if u==42 or u==54 then l=true elseif u==58 then m=not m end elseif s=="key_up"then if u==42 or u==54 then l=false end end else if s=="key_down"then if u==28 then if n=="exit"then return elseif n=="reboot"then computer.shutdown(1)elseif n=="shutdown"then computer.shutdown()end;result,reason=pcall(load(n))o=true;if reason then local v=false;for j in string.gmatch(reason,"[^\r\n]+")do if#reason>e then v=true;for k=1,math.ceil(#reason/e)do buffer[#buffer+1]=string.sub(reason,k==1 and 1 or e*(k-1),e*k)end else buffer[#buffer+1]=reason end end;if v then g("")end end;if type(buffer)~="table"then _G.buffer={}end;buffer[#buffer+1]="bootloader> "n=""goto q elseif u==14 then if#buffer[#buffer]>12 then n=string.sub(n,1,#n-1)buffer[#buffer]=string.sub(buffer[#buffer],1,#buffer[#buffer]-1)end;goto q elseif t<127 and t>31 then local w=string.char(t)if l or m then w=string.upper(w)end;buffer[#buffer]=buffer[#buffer]..w;n=n..w end elseif s=="clipboard"then buffer[#buffer]=buffer[#buffer]..t;n=n..t end end;goto q end;local l=false;local m=false;local function x(y)if y then if d.getDepth()>1 then d.setBackground(0x9cc3db)d.setForeground(0x003150)else d.setBackground(0xFFFFFF)d.setForeground(0x000000)end else if d.getDepth()>1 then d.setBackground(0x003150)d.setForeground(0x9cc3db)else d.setBackground(0x000000)d.setForeground(0xFFFFFF)end end end;x(false)local z={y=math.ceil(f/2)-2,button_offset=4,button_height=1,opts={},optcount=0}if d.getDepth()>1 then _G.row_2={y=math.ceil(f/2)+2,button_offset=2,button_height=0,opts={"Power off",computer.getArchitecture(),"Internet boot","Rename","Format"},optcount=5}else _G.row_2={y=math.ceil(f/2)+2,button_offset=2,button_height=0,opts={"Halt","Shell","Netboot","Rename","Format"},optcount=5}end;local A=component.list("filesystem")()local B={}local C;z.opts={}if component.list("filesystem")()then for k in pairs(component.list("filesystem"))do local D=component.invoke(k,"getLabel")if D=="tmpfs"then goto E end;D=D~=nil and D or string.sub(k,1,5)B[k]=0;for j,F in ipairs(component.invoke(k,"list","/"))do if F=="init.lua"then B[k]=B[k]+1 elseif F=="OS.lua"then B[k]=B[k]+2 end end;if not C then C=D end;z.opts[k]=D;z.optcount=z.optcount+1::E::end else blue.fn.shell()computer.shutdown(1)end;local G=z;local H=1::q::if component.list("filesystem")()~=A then goto a end;d.fill(1,1,e,f," ")if H<1 then H=G.optcount elseif H>G.optcount then H=1 end;local I=0;local function J(K)local L=""local M={}local N;for j,F in pairs(K.opts)do I=I+1;N=string.rep(" ",K.button_offset)..F..string.rep(" ",K.button_offset)M[#M+1]=N;L=L..N end;I=0;return L,M end;local O,P=J(z)local Q,R=J(row_2)if G==z then local S=0;for k,F in pairs(z.opts)do S=S+1;local T=F==string.match(P[H],"^%s*(.-)%s*$")local U=S==H;if T and U then C=k;break end end end;d.set(math.ceil(e/2)-math.ceil(#O/2),z.y,O)d.set(math.ceil(e/2)-math.ceil(#Q/2),row_2.y,Q)if d.getDepth()>1 then d.set(math.ceil(e/2)-math.ceil(75/2),f,"Use ← ↑ → ↓ to move cursor; Enter to confirm option; CTRL+ALT+C to shutdown")else d.set(math.ceil(e/2)-math.ceil(26/2),f,"Use ← ↑ → ↓ to move cursor")end;if G==z then _G.button_string=P[H]or P[#P]_G.full_string=O;_G.determined_x=math.ceil(e/2)-math.ceil(#O/2)_G.determined_y=z.y;_G.row_opts=P else _G.button_string=R[H]or R[#R]_G.full_string=Q;_G.determined_x=math.ceil(e/2)-math.ceil(#Q/2)_G.determined_y=row_2.y;_G.row_opts=R end;local V=0;for k,F in ipairs(row_opts)do if F==button_string and k==H then V=V+1;break else V=V+#F end end;x(true)d.set(determined_x+V-1,determined_y,button_string)if G.button_height>0 then for k=1,G.button_height do local i=string.rep(" ",#button_string)d.set(determined_x+V-1,determined_y-k,i)d.set(determined_x+V-1,determined_y+k,i)end end;x(false)repeat local s,j,j,u=computer.pullSignal()if s=="key_down"then if u==200 then G=z elseif u==208 then G=row_2 elseif u==203 then H=H-1 elseif u==205 then H=H+1 elseif u==42 or u==54 then l=true elseif u==58 then m=not m elseif u==29 or u==157 then b=true elseif u==56 or u==184 then c=true elseif u==46 then if b and c then computer.shutdown()end elseif u==28 then if G==z then local W=pcall(component.invoke,C,"getLabel")if not W then goto a end;local i="Booting..."d.setForeground(0xcccccc)d.fill(1,math.ceil(f/2)+5,e,1," ")d.set(math.ceil(e/2)-math.ceil(#i/2),math.ceil(f/2)+5,i)if blue.vb.boot_drive==C then x(false)break end;local X=component.proxy(C)local D=X.getLabel()local function Y(Z)local _=X.open(Z)if _ then local a0=""::a1::local a2=X.read(_,math.huge)if a2 then a0=a0 ..a2;goto a1 end;X.close(_)return a0 end end;if not D then D="N/A"end;local a3=false;if B[C]==1 then blue.vb.init=Y("/init.lua")a3=true elseif B[C]>1 then blue.vb.init=Y("/OS.lua")a3=true elseif B[C]==0 then i="Unable to boot; missing boot files"d.fill(1,math.ceil(f/2)+5,e,1," ")d.set(math.ceil(e/2)-math.ceil(#i/2),math.ceil(f/2)+5,i)x(false)a3=false;computer.pullSignal()computer.pullSignal()end;if a3 then blue.vb.boot_label=D;blue.vb.boot_drive=C;computer.setBootAddress(C)x(false)break end else if H==1 then computer.shutdown()elseif H==2 then blue.fn.shell()elseif H==3 then d.setForeground(0xcccccc)if component.list("internet")()then local a4=component.proxy(component.list("internet")())local i="URL: "d.fill(1,math.ceil(f/2)+5,e,1," ")repeat d.set(math.ceil(e/2)-math.ceil(#i/2),math.ceil(f/2)+5,i)local s,j,t,u=computer.pullSignal()if s=="key_down"then if u==42 or u==54 then l=true elseif u==58 then m=not m elseif u==14 then if#i>5 then i=string.sub(i,1,#i-1)d.fill(1,math.ceil(f/2)+5,e,1," ")end elseif t>31 and t<127 then if l or m then i=i..string.upper(string.char(t))else i=i..string.char(t)end elseif u==28 then d.fill(1,math.ceil(f/2)+5,e,1," ")d.set(math.ceil(e/2)-7,math.ceil(f/2)+5,"Downloading...")local a5=a4.request(string.sub(i,6,#i))if a5 then local a0=""::a6::local a2=a5.read()if a2 then a0=a0 ..a2;goto a6 end;if a0 and a0~=""then local a7,reason=pcall(function()return load(a0)()end)if a7 then goto a else d.fill(1,math.ceil(f/2)+5,e,1," ")d.set(math.ceil(e/2)-math.ceil(#reason/2),math.ceil(f/2)+5,reason)computer.pullSignal()computer.pullSignal()break end else d.fill(1,math.ceil(f/2)+5,e,1," ")i="An error occured."d.set(math.ceil(e/2)-math.ceil(#i/2),math.ceil(f/2)+5,i)end else d.fill(1,math.ceil(f/2)+5,e,1," ")i="An error occured."d.set(math.ceil(e/2)-math.ceil(#i/2),math.ceil(f/2)+5,i)computer.pullSignal()computer.pullSignal()break end end elseif s=="key_up"then if u==42 or u==54 then l=false end elseif s=="clipboard"then i=i..t end until false;x(false)else d.fill(1,math.ceil(f/2)+5,e,1," ")local i="This feature requires an internet card to run."d.set(math.ceil(e/2)-math.ceil(#i/2),math.ceil(f/2)+5,i)computer.pullSignal()computer.pullSignal()end;x(false)elseif H==4 then local i="New label: "d.fill(1,math.ceil(f/2)+5,e,1," ")repeat d.setForeground(0xcccccc)d.set(math.ceil(e/2)-math.ceil(#i/2),math.ceil(f/2)+5,i)local s,j,t,u=computer.pullSignal()if s=="key_down"then if u==42 or u==54 then l=true elseif u==58 then m=not m elseif u==14 then if#i>11 then i=string.sub(i,1,#i-1)d.fill(1,math.ceil(f/2)+5,e,1," ")end elseif t>31 and t<127 then if l or m then i=i..string.upper(string.char(t))else i=i..string.char(t)end elseif u==28 then local D=string.sub(i,12,#i)local result,reason;if D==""then result,reason=pcall(component.invoke,C,"setLabel",nil)else result,reason=pcall(component.invoke,C,"setLabel",D)end;if not result then d.fill(1,math.ceil(f/2)+5,e,1," ")i="An error has occured: "..reason;d.set(math.ceil(e/2)-math.ceil(#i/2),math.ceil(f/2)+5,i)computer.pullSignal()computer.pullSignal()x(false)break else x(false)break end end elseif s=="key_up"then if u==42 or u==54 then l=false end elseif s=="clipboard"then i=i..t end until false;goto a elseif H==5 then d.fill(1,math.ceil(f/2)+5,e,1," ")d.setForeground(0xcccccc)local D=component.invoke(C,"getLabel")local i="Format "..(D~=nil and D or"N/A").." ("..C..")? (Y/N)"d.set(math.ceil(e/2)-math.ceil(#i/2),math.ceil(f/2)+5,i)repeat local s,j,t=computer.pullSignal()if s=="key_down"then if string.char(t)=="y"then d.fill(1,math.ceil(f/2)+5,e,1," ")i="Formatting..."local a8=computer.uptime()d.set(math.ceil(e/2)-math.ceil(#i/2),math.ceil(f/2)+5,i)local a9=component.proxy(C)local function aa(ab)for j,k in ipairs(a9.list(ab~=nil and ab or"/"))do if string.match(k,"/$")~=nil then aa("/"..(ab~=nil and ab or"")..k)else a9.remove("/"..(ab~=nil and ab or"")..k)end end end;a9.setLabel(nil)aa()if a8==computer.uptime()then i="Formatted in less than a second"else i="Formatted in "..computer.uptime()-a8 .." seconds"end;d.set(math.ceil(e/2)-math.ceil(#i/2),math.ceil(f/2)+5,i)computer.pullSignal()computer.pullSignal()break else break end end until false;goto a end end end elseif s=="key_up"then if u==42 or u==54 then l=false elseif u==29 or u==157 then b=false elseif u==56 or u==184 then c=false end end;goto q until false
